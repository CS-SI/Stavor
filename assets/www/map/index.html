<html>
    <head>
        <title>OpenLayers Mobile</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <meta name="apple-mobile-web-app-capable" content="yes">
    	<link rel="stylesheet" href="theme/default/style.css" type="text/css">
        <link rel="stylesheet" href="theme/default/style.mobile.css" type="text/css">
  	<script type='text/javascript' src="MultiPath.js"></script>
  	<script type='text/javascript' src="interface.js"></script>
  	<!--<script src="http://www.openlayers.org/api/OpenLayers.js"></script>-->
	<script src="OpenLayers.mobile.js"></script>
        <script src="mobile.js"></script>

	<script type="text/javascript" src="proj4js/proj4.js"></script>
	<script type="text/javascript" src="greatCircle.js"></script>
	<script type="text/javascript" src="greatcirclemod.js"></script>
	<SCRIPT type="text/javascript" src="proj4js/data/tmerc.js"></SCRIPT>
	<SCRIPT type="text/javascript" src="proj4js/data/merc.js"></SCRIPT>
	<SCRIPT type="text/javascript" src="proj4js/data/EPSG31466.js"></SCRIPT>
	<SCRIPT type="text/javascript" src="proj4js/data/EPSG31467.js"></SCRIPT>
	<SCRIPT type="text/javascript" src="proj4js/data/EPSG900913.js"></SCRIPT>
	<!--<script type="text/javascript" src="javascript/counter_orthodrome.js"></script>-->
	<script type="text/javascript" src="arc.js"></script>
	<style>
            html, body {
                margin  : 0;
                padding : 0;
                height  : 100%;
                width   : 100%;
            }
            @media only screen and (max-width: 600px) {
                html, body {
                    height  : 117%;
                }
            }
            #map {
                width    : 100%;
                position : absolute;
                height   : 100%;
            }
            .olControlAttribution {
                position      : absolute;
                font-size     : 10px;
                bottom        : 0 !important;
                right         : 0 !important;
                background    : rgba(0,0,0,0.1);
                font-family   : Arial;
                padding       : 2px 4px;
                border-radius : 5px 0 0 0;
            }
            #title, #tags, #shortdesc {
                display: none;
            }
        </style>
    </head>
<body>
  <div id="map"></div>
  <script>
	setLoadingProgress(10);

	//DYNAMIC PARAMS
	var follow_sc = false;
	//var points = new Array();
	var fov = new Array();
	var sun_lat = 0;
	var sun_lon = 0;
	var station_areas = new Array();

	//CONFIG PARAMS
	var payload_beamwidth = 5;//Degrees
	var param_path_max_length = 5000;

	var station_a = new Object();
	station_a.name = "AAA";
	station_a.latitude = 20;
	station_a.longitude = 20;
	station_a.beamwidth = 5;
	var station_b = new Object();
	station_b.name = "BBB";
	station_b.latitude = -20;
	station_b.longitude = -20;
	station_b.beamwidth = 7;
	var stations = new Array(station_a,station_b);

	//HARD-CODED PARAMS
	var sc_altitude_step = 10;

	//VOLATILE PARAMS
	var sc_latitude = 0;
	var sc_altitude_tmp = 0;
	var sc_longitude = 0;
	var sc_altitude = 0;
	var night_line_init = false;
	var sun_lon_tmp = 0;

	init();
    	var lonLat = new OpenLayers.LonLat( 0.0 ,0.0 )
	  .transform(
	    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
	    map.getProjectionObject() // to Spherical Mercator Projection
	  );
 
   	var zoom=0;

	map.setCenter (lonLat, zoom);
	setLoadingProgress(60);

 /*
    var markers = new OpenLayers.Layer.Markers( "Markers" );
    map.addLayer(markers);
 
    markers.addMarker(new OpenLayers.Marker(lonLat));
 
    
*/

//******************************************************
//         SUN MARKER
//******************************************************

	var sun_layer = new OpenLayers.Layer.Vector( "Sun Marker" );
	map.addLayer(sun_layer);

//******************************************************
//         NIGHT LINE
//******************************************************

	var night_layer = new OpenLayers.Layer.Vector("Night Layer");
	map.addLayer(night_layer);
    	orthodromeFlag=true;

//******************************************************
//         STATION BW
//******************************************************

	/*var station_style = {
	      strokeColor: "#00FF00",
	      strokeOpacity: 0.4,
	      strokeWidth: 1,
	      fillOpacity: 0.2,
		fillColor: "#22FF00"
	};

	var stations_layer = new OpenLayers.Layer.Vector("Stations Layer");
	map.addLayer(stations_layer);*/

//******************************************************
//         STATION AREA
//******************************************************

	var station_area_style = {
	      strokeColor: "#009c00",
	      strokeOpacity: 0.5,
	      strokeWidth: 1,
	      fillOpacity: 0.1,
		fillColor: "#00FF00"
	};

	var station_area_style2 = {
	      strokeColor: "#00009c",
	      strokeOpacity: 0.5,
	      strokeWidth: 1,
	      fillOpacity: 0.1,
		fillColor: "#0000FF"
	};

	var Rt = 6371000;

	var stations_area_layer = new OpenLayers.Layer.Vector("Stations Area Layer");

	/*var stations_area_layer = new OpenLayers.Layer.Vector("Stations Area Layer", {
		   projection: map.displayProjection,
		   preFeatureInsert: function(feature) {
		   	feature.geometry.transform(new OpenLayers.Projection("EPSG:4258"), new OpenLayers.Projection("EPSG:4326"));
		   }
		}); */

	map.addLayer(stations_area_layer);


//******************************************************
//         STATION NAME
//******************************************************
	var stationNameStyle = 
		OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
	stationNameStyle.strokeColor = "#098700";
	stationNameStyle.strokeOpacity = "0.8";
	stationNameStyle.strokeWidth = "0.1";
	stationNameStyle.fillColor = "#00FF00";
	stationNameStyle.fillOpacity = 0.4;
	stationNameStyle.strokeWidth = 1;
	stationNameStyle.label = "${label}";
	stationNameStyle.labelOutlineColor = "white";
	stationNameStyle.labelOutlineWidth = 0.3;
	stationNameStyle.fontSize="10px";
	stationNameStyle.fontWeight="bold";
	stationNameStyle.fontColor="#000000";
	stationNameStyle.pointRadius="1";
	stationNameStyle.labelYOffset="10";	
	
	var smap = new OpenLayers.StyleMap({"default": stationNameStyle});

	var stations_name_layer = new OpenLayers.Layer.Vector("StationsName Layer", {"styleMap": smap});
	map.addLayer(stations_name_layer);

//******************************************************
//         PATH
//******************************************************
	var style_path = { 
		strokeColor: '#ff0000', 
	  	strokeOpacity: 0.5,
	  	strokeWidth: 3
	};

	var lineLayer = new OpenLayers.Layer.Vector("Line Layer"); 
	map.addLayer(lineLayer);                    
	map.addControl(new OpenLayers.Control.DrawFeature(lineLayer, OpenLayers.Handler.Path)); 

//******************************************************
//         SPACECRAFT
//******************************************************
	var sc_style = {
	      strokeColor: "#FF0000",
	      strokeOpacity: 0.5,
	      strokeWidth: 1,
	      fillOpacity: 0.3,
		fillColor: "#FF2200"
	};

	var sc_layer = new OpenLayers.Layer.Vector("SC Layer");
	map.addLayer(sc_layer);

//******************************************************
//---------------------- INIT --------------------------
//******************************************************

	getInitialization();

	//PRE-STORED PATH
/*	var line = new OpenLayers.Geometry.LineString(points);

	var lineFeature = new OpenLayers.Feature.Vector(line, null, style_path);

	lineLayer.addFeatures([lineFeature]);
*/
	lineLayer.addFeatures([myMultyPath.getFeature()]);

	//STATIONS NAME
	for (var arrayIndex in stations){
		var point = new OpenLayers.Geometry.Point(stations[arrayIndex].longitude, stations[arrayIndex].latitude).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
		var station_name_feature = new OpenLayers.Feature.Vector(point, null, null);
		station_name_feature.attributes = {
			label:stations[arrayIndex].name
		}
		stations_name_layer.addFeatures([station_name_feature]);
	}

	setLoadingProgress(100);

//------------------------------------------------------------------------------

	function reDraw(){
		//Sun
		sun_layer.removeAllFeatures();    
		var marker_sun = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(sun_lon, sun_lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()), null, {
			externalGraphic: "sun.png",
			graphicWidth: 32,
			graphicHeight: 32,
			fillOpacity: 1
		});
		sun_layer.addFeatures([marker_sun]);

	//Night line
		/*if(!night_line_init){
			if(sun_lon!=0.0){
				show_nightline(new OpenLayers.Geometry.Point(sun_lon, 90.0).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
						new OpenLayers.Geometry.Point(sun_lon+90,0.0).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
				night_line_init = true;
			}
		}else{
			for( var j=0; j < night_layer.features.length; j++){
				night_layer.features[j].geometry.move((sun_lon-sun_lon_tmp)*OpenLayers.INCHES_PER_UNIT['degrees'] / OpenLayers.INCHES_PER_UNIT['m'],0);
				night_layer.features[j].layer.drawFeature(night_layer.features[j]);
			}
		}
		sun_lon_tmp = sun_lon;*/
//***********************************************
		
		/*if(!night_line_init){
			if(sun_lon!=0.0){

				var start = { x: sun_lon, y: 85.0 };
				var end = { x: sun_lon+90.0, y: 0.0 };
				var generator = new arc.GreatCircle(start, end, {'name': 'NightLine'});
				var line = generator.Arc(100,{offset:10});
				
				night_layer.addFeatures([new OpenLayers.Geometry.LineString()]);
				night_line_init = true;
			}
		}else{
			for( var j=0; j < night_layer.features.length; j++){
				night_layer.features[j].geometry.move((sun_lon-sun_lon_tmp)*OpenLayers.INCHES_PER_UNIT['degrees'] / OpenLayers.INCHES_PER_UNIT['m'],0);
				night_layer.features[j].layer.drawFeature(night_layer.features[j]);
			}
		}
		sun_lon_tmp = sun_lon;*/

	//Path
		//line = new OpenLayers.Geometry.LineString(points);
		lineLayer.removeAllFeatures();
		/*var lineFeature = new OpenLayers.Feature.Vector(line, null, style_path);
		lineLayer.addFeatures([lineFeature]);*/
		lineLayer.addFeatures([myMultyPath.getFeature()]);

	//Spacecraft
		/*var radius = sc_altitude*Math.tan((payload_beamwidth*Math.PI/180)/2);
		var sc_position = points[points.length-1];
		var circle = OpenLayers.Geometry.Polygon.createRegularPolygon(
		    sc_position,
		    radius,
		    30 // According to the API you only need 20 sides to approximate a circle.
		);
		sc_layer.removeAllFeatures();
		var sc_feature = new OpenLayers.Feature.Vector(circle, null, sc_style);
		sc_layer.addFeatures([sc_feature]);*/

		var fovPoints = [];
		for (var i in fov) {
			var point = new OpenLayers.Geometry.Point(fov[i].longitude, fov[i].latitude);
			// transform from WGS 1984 to Spherical Mercator
			point.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
			fovPoints.push(point);
		}				
		//areaPoints.push(areaPoints[0]);

		var linearRing = new OpenLayers.Geometry.LinearRing(fovPoints);
		var geometry = new OpenLayers.Geometry.Polygon([linearRing]);
		var polygonFeature = new OpenLayers.Feature.Vector(geometry, null, sc_style);
		sc_layer.removeAllFeatures();
		sc_layer.addFeatures([polygonFeature]);

	//Follow Spacecraft
		if(follow_sc){
		    	var lonLat = new OpenLayers.LonLat( sc_longitude ,sc_latitude )
			  .transform(
			    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
			    map.getProjectionObject() // to Spherical Mercator Projection
			  );
			map.setCenter(lonLat, map.getZoom());
		}

	//Stations	
		drawStationsAreas();	
	}



function drawStationsAreas(){
	if(Math.abs(sc_altitude-sc_altitude_tmp)>sc_altitude_step){
		stations_area_layer.removeAllFeatures();
		for (var arrayIndex in station_areas){

		//***************************** Splitted alternative parts, only dateline
			var areaFirst = [];
			var areaSecond = [];
			var area_tmp_long = 0, area_tmp_lat = 0;
			var first = true;
			for (var i in station_areas[arrayIndex].points) {
				var coord = station_areas[arrayIndex].points[i];
				var point = new OpenLayers.Geometry.Point(
									coord.longitude, 
									coord.latitude
					).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());

				if((i!=0) && ((coord.longitude*area_tmp_long)<0) && (Math.abs(coord.longitude)>90.0) && (area_tmp_long+coord.longitude<90.0)){
					var avg_lat = (coord.latitude+area_tmp_lat)/2;
					if(coord.longitude > 0)
						var new_lon = -179.999999;
					else
						var new_lon = 179.999999;
					if(first){
						areaFirst.push(new OpenLayers.Geometry.Point(new_lon, avg_lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
						areaSecond.push(new OpenLayers.Geometry.Point(-new_lon, avg_lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
						first=false;
					}else{
						areaFirst.push(new OpenLayers.Geometry.Point(-new_lon, avg_lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
						areaSecond.push(new OpenLayers.Geometry.Point(+new_lon, avg_lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
						first=true;
					}
				}
				area_tmp_lat = coord.latitude;
				area_tmp_long = coord.longitude;

				if(first){
					areaFirst.push(point);
				}else{
					areaSecond.push(point);
				}					
			}				
			if(areaFirst.length>0){
				areaFirst.push(areaFirst[0]);
				var linearRing = new OpenLayers.Geometry.LinearRing(areaFirst);
				var geometry = new OpenLayers.Geometry.Polygon([linearRing]);
				var polygonFeature = new OpenLayers.Feature.Vector(geometry, null, station_area_style);
				stations_area_layer.addFeatures([polygonFeature]);
			}
			if(areaSecond.length>0){
				areaSecond.push(areaSecond[0]);
				var linearRing = new OpenLayers.Geometry.LinearRing(areaSecond);
				var geometry = new OpenLayers.Geometry.Polygon([linearRing]);
				var polygonFeature = new OpenLayers.Feature.Vector(geometry, null, station_area_style2);
				stations_area_layer.addFeatures([polygonFeature]);
			}


			/*
			var radius = Rt*Math.sin(Math.acos(Rt/(Rt+sc_altitude-stations[arrayIndex].ellipsoid_elevation)));
			
			var circle = OpenLayers.Geometry.Polygon.createRegularPolygon(
			    new OpenLayers.Geometry.Point(stations[arrayIndex].longitude, stations[arrayIndex].latitude).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
			    radius,
			    30 
			);

			//circle.transform(new OpenLayers.Projection("EPSG:4258"), map.getProjectionObject());
			var station_feature = new OpenLayers.Feature.Vector(circle, null, station_area_style);
			stations_area_layer.addFeatures([station_feature]);
			*/

			/*var areaPositive = [];
			var areaNegative = [];
			var area_tmp_long = 0, area_tmp_lat = 0;
			var positive_tmp = true;
			//***************************** Splitted positive negative
			for (var i in station_areas[arrayIndex].points) {
				var coord = station_areas[arrayIndex].points[i];
				var point = new OpenLayers.Geometry.Point(coord.longitude, coord.latitude);
				// transform from WGS 1984 to Spherical Mercator
				point.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
				var positive = (coord.longitude>=0);
				if((i!=0) && positive!=positive_tmp){
					var avg_lat = (coord.latitude+area_tmp_lat)/2;
					if(Math.abs(coord.longitude-area_tmp_long)>90)
						var new_lon = 179.999999;
					else
						var new_lon = 0;
					areaPositive.push(new OpenLayers.Geometry.Point(new_lon, avg_lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
					areaNegative.push(new OpenLayers.Geometry.Point(-new_lon, avg_lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
				}
				area_tmp_lat = coord.latitude;
				area_tmp_long = coord.longitude;
				positive_tmp = (coord.longitude>=0);

				if(positive){
					areaPositive.push(point);
				}else{
					areaNegative.push(point);
				}					
			}				
			if(areaPositive.length>0){
				areaPositive.push(areaPositive[0]);
				var linearRing = new OpenLayers.Geometry.LinearRing(areaPositive);
				var geometry = new OpenLayers.Geometry.Polygon([linearRing]);
				var polygonFeature = new OpenLayers.Feature.Vector(geometry, null, station_area_style);
				stations_area_layer.addFeatures([polygonFeature]);
			}
			if(areaNegative.length>0){
				areaNegative.push(areaNegative[0]);
				var linearRing = new OpenLayers.Geometry.LinearRing(areaNegative);
				var geometry = new OpenLayers.Geometry.Polygon([linearRing]);
				var polygonFeature = new OpenLayers.Feature.Vector(geometry, null, station_area_style2);
				stations_area_layer.addFeatures([polygonFeature]);
			}*/





			//***************************** Single polygon

			/*for (var i in station_areas[arrayIndex].points) {
				var coord = station_areas[arrayIndex].points[i];
				var positive = (coord.longitude>=0);
				if((i!=0) && positive!=positive_tmp){						
					if(Math.abs(coord.longitude)>90)
						var point = new OpenLayers.Geometry.Point(-180-coord.longitude, coord.latitude);
					else
						var point = new OpenLayers.Geometry.Point(coord.longitude, coord.latitude);
					// transform from WGS 1984 to Spherical Mercator
					point.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
					areaPositive.push(point);
				}else{
					var point = new OpenLayers.Geometry.Point(coord.longitude, coord.latitude);
					// transform from WGS 1984 to Spherical Mercator
					point.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
					areaPositive.push(point);
				}
				positive_tmp = (coord.longitude>=0);				
			}				
			if(areaPositive.length>0){
				areaPositive.push(areaPositive[0]);
				var linearRing = new OpenLayers.Geometry.LinearRing(areaPositive);
				var geometry = new OpenLayers.Geometry.Polygon([linearRing]);
				var polygonFeature = new OpenLayers.Feature.Vector(geometry, null, station_area_style);
				stations_area_layer.addFeatures([polygonFeature]);
			}*/




			//***************************** LineStrings

			/*for (var i in station_areas[arrayIndex].points) {
				var coord = station_areas[arrayIndex].points[i];
				
				var point = new OpenLayers.Geometry.Point(coord.longitude, coord.latitude);
				// transform from WGS 1984 to Spherical Mercator
				point.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
				areaPositive.push(point);
			}				
			if(areaPositive.length>0){
				areaPositive.push(areaPositive[0]);
				var linearRing = new OpenLayers.Geometry.LineString(areaPositive);
				var polygonFeature = new OpenLayers.Feature.Vector(linearRing, null, station_area_style);
				stations_area_layer.addFeatures([polygonFeature]);
			}*/







		}
	
		sc_altitude_tmp = sc_altitude;
	}

}
  </script>
</body></html>
