<html>
    <head>
        <title>OpenLayers Mobile</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="theme/default/style.mobile.css" type="text/css">
  	<script type='text/javascript' src="interface.js"></script>
  	<!--<script src="http://www.openlayers.org/api/OpenLayers.js"></script>-->
	<script src="OpenLayers.mobile.js"></script>
        <script src="mobile.js"></script>
	<style>
            html, body {
                margin  : 0;
                padding : 0;
                height  : 100%;
                width   : 100%;
            }
            @media only screen and (max-width: 600px) {
                html, body {
                    height  : 117%;
                }
            }
            #map {
                width    : 100%;
                position : relative;
                height   : 100%;
            }
            .olControlAttribution {
                position      : absolute;
                font-size     : 10px;
                bottom        : 0 !important;
                right         : 0 !important;
                background    : rgba(0,0,0,0.1);
                font-family   : Arial;
                padding       : 2px 4px;
                border-radius : 5px 0 0 0;
            }
            #title, #tags, #shortdesc {
                display: none;
            }
        </style>
    </head>
<body>
  <div id="map"></div>
  <script>
	setLoadingProgress(10);
	
	//DYNAMIC PARAMS
	var follow_sc = false;
	var points = new Array();

	//CONFIG PARAMS
	var payload_beamwidth = 5;//Degrees

	var station_a = new Object();
	station_a.latitude = 20;
	station_a.longitude = 20;
	station_a.beamwidth = 5;
	var station_b = new Object();
	station_b.latitude = -20;
	station_b.longitude = -20;
	station_b.beamwidth = 7;
	var stations = new Array(station_a,station_b);

	//HARD-CODED PARAMS
	var param_path_max_length = 5000;

	//VOLATILE PARAMS
	var sc_latitude = 0;
	var sc_longitude = 0;
	var sc_altitude = 0;

	init();

    	var lonLat = new OpenLayers.LonLat( 0.0 ,0.0 )
	  .transform(
	    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
	    map.getProjectionObject() // to Spherical Mercator Projection
	  );
 
   	var zoom=0;

	map.setCenter (lonLat, zoom);
	setLoadingProgress(60);
 /*
    var markers = new OpenLayers.Layer.Markers( "Markers" );
    map.addLayer(markers);
 
    markers.addMarker(new OpenLayers.Marker(lonLat));
 
    
*/
	var lineLayer = new OpenLayers.Layer.Vector("Line Layer"); 
	map.addLayer(lineLayer);                    
	map.addControl(new OpenLayers.Control.DrawFeature(lineLayer, OpenLayers.Handler.Path)); 

	var sc_layer = new OpenLayers.Layer.Vector("SC Layer");
	map.addLayer(sc_layer);

	var stations_layer = new OpenLayers.Layer.Vector("Stations Layer");
	map.addLayer(stations_layer);

	getInitialization();
	//var polyOptions = {sides: 40};                              
	//map.addControl(new OpenLayers.Control.DrawFeature(sc_layer, OpenLayers.Handler.RegularPolygon,{handlerOptions: polyOptions}));     
	/*var points = new Array(
	   new OpenLayers.Geometry.Point(1.0, 1.0).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
	   new OpenLayers.Geometry.Point(20.0, 20.0).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
	   new OpenLayers.Geometry.Point(20.0, 30.0).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
	   new OpenLayers.Geometry.Point(20.0, 40.0).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
	   new OpenLayers.Geometry.Point(40.0, 40.0).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject())
	);*/


	var line = new OpenLayers.Geometry.LineString(points);

	var style = { 
	  strokeColor: '#ff0000', 
	  strokeOpacity: 0.5,
	  strokeWidth: 3
	};

	var lineFeature = new OpenLayers.Feature.Vector(line, null, style);
	lineLayer.addFeatures([lineFeature]);

	//Circle --------------------------------------------------

	var sc_style = {
	      strokeColor: "#FF0000",
	      strokeOpacity: 0.5,
	      strokeWidth: 1,
	      fillOpacity: 0.3,
		fillColor: "#FF2200"
	};
	//End circle ----------------------------------------------

	//Stations --------------------------------------------------

	/*var circle = OpenLayers.Geometry.Polygon.createRegularPolygon(
	    new OpenLayers.Geometry.Point(0, 0),
	    1500*1000,
	    20 // According to the API you only need 20 sides to approximate a circle.
	);*/
	var station_style = {
	      strokeColor: "#00FF00",
	      strokeOpacity: 0.4,
	      strokeWidth: 1,
	      fillOpacity: 0.2,
		fillColor: "#22FF00"
	};
	//var sc_feature = new OpenLayers.Feature.Vector(circle, null, sc_style);
	//sc_layer.addFeatures([sc_feature]);
	//End stations ----------------------------------------------

	setLoadingProgress(100);

//------------------------------------------------------------------------------

	function reDraw(){
		//Path
		line = new OpenLayers.Geometry.LineString(points);
		lineLayer.removeAllFeatures();
		var lineFeature = new OpenLayers.Feature.Vector(line, null, style);
		lineLayer.addFeatures([lineFeature]);

		//Spacecraft
		var radius = sc_altitude*Math.tan((payload_beamwidth*Math.PI/180)/2);
		var sc_position = points[points.length-1];
		var circle = OpenLayers.Geometry.Polygon.createRegularPolygon(
		    sc_position,
		    radius,
		    20 // According to the API you only need 20 sides to approximate a circle.
		);
		sc_layer.removeAllFeatures();
		var sc_feature = new OpenLayers.Feature.Vector(circle, null, sc_style);
		sc_layer.addFeatures([sc_feature]);
		//Follow Spacecraft
		if(follow_sc){
		    	var lonLat = new OpenLayers.LonLat( sc_longitude ,sc_latitude )
			  .transform(
			    new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
			    map.getProjectionObject() // to Spherical Mercator Projection
			  );
			map.setCenter(lonLat, map.getZoom());
		}

		//Stations		
		stations_layer.removeAllFeatures();
		for (var arrayIndex in stations){
			var radius = (sc_altitude-stations[arrayIndex].ellipsoid_elevation)*Math.tan((stations[arrayIndex].beam_width*Math.PI/180)/2);
			var circle = OpenLayers.Geometry.Polygon.createRegularPolygon(
			    new OpenLayers.Geometry.Point(stations[arrayIndex].longitude, stations[arrayIndex].latitude).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()),
			    radius,
			    20 // According to the API you only need 20 sides to approximate a circle.
			);
			var station_feature = new OpenLayers.Feature.Vector(circle, null, station_style);
			stations_layer.addFeatures([station_feature]);
		}
	}
	function clearPath(){
		points = new Array();
		lineLayer.removeAllFeatures();
		sc_layer.removeAllFeatures();
		stations_layer.removeAllFeatures();
		//reDraw();
	}
	/*function addPoint(lat, lon){
		points.push(new OpenLayers.Geometry.Point(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
		reDraw();
	}*/
	function addPoints(points_ext){
		var points_ext_ol = new Array();
		for (var arrayIndex in points_ext) {		
			points_ext_ol.push(new OpenLayers.Geometry.Point(points_ext[arrayIndex].longitude, points_ext[arrayIndex].latitude).transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject()));
		}
		points = points.concat(points_ext_ol);
		//Limit path length
		if(points.length>param_path_max_length){
			points = points.slice(points.length-param_path_max_length);
		}
		sc_latitude = points_ext[points_ext.length-1].latitude;
		sc_longitude = points_ext[points_ext.length-1].longitude;
		sc_altitude = points_ext[points_ext.length-1].altitude;
		reDraw();
	}

function changeView(view_mode){
	switch(view_mode){
		case "Free"://free
			follow_sc = false;
			break;
		case "Locked"://locked
			follow_sc = true;
			break;
		default://xyz
			follow_sc = false;
			break;
	}
}


  </script>
</body></html>
